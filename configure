#!/bin/bash


rm config.h Makefile.config
str1="Generated by configure script ran as" 
str2="$@" 

echo -e "// $str1\n// $str2\n" >> config.h
echo -e "# $str1\n# $str2\n" >> Makefile.config

function prn_feature () 
{
    var=`echo $1 | tr [a-z] [A-Z]`
    val=`eval echo \\$enable_$1`
    if [ -z "$val" ]; then
        echo "#undef ENABLE_$var" >> config.h
        echo "ENABLE_$var =" >> Makefile.config
    else
        echo "#define ENABLE_$var \"$val\"" >> config.h
        echo "ENABLE_$var = $val" >> Makefile.config
    fi
    printf "  %-13s = %s\n" enable_$1 "$val"
}

function prn_var () 
{
    var=`echo $1 | tr [a-z] [A-Z]`
    val=`eval echo \\$$1`
    echo "#define $var \"$val\"" >> config.h
    echo "$var = $val" >> Makefile.config
    printf "  %-13s = %s\n" $1 "$val"
}

function prn_help () 
{
    echo usage bla-bla-bla    
    exit 
}

function check_var () 
{
    case $1 in
    prefix | exec_prefix | bindir | libexecdir | datadir | mandir )
        eval "$1=\"$2\""
        ;;
    * )
        echo "ingoring unknown variable $1"
        ;;
    esac
}

function check_feature ()
{
    case $1 in
    devel | cpu )
        eval "enable_$1=\"$2\""
        ;;
    * )
        echo "ignoring unknown feature $1"
        ;;
    esac

}



while [ $# -gt 0 ]; do
    [ "$1" == "-h" -o "$1" == "--help" ] && prn_help  
    cmd=`echo $1 | awk '
        { 
            if (match($0, "--disable-([^[:space:]=]+)$", a)) {
                gsub("-", "_", a[1]);
                print "check_feature " a[1] " \"\"";
            } else if (match($0, "--enable-([^[:space:]=]+)$", a)) {
                gsub("-", "_", a[1]);
                print "check_feature " a[1] " yes";
            } else if (match($0, "--enable-([^[:space:]=]+)=(.+)", a)) {
                gsub("-", "_", a[1]);
                print "check_feature " a[1] " \"" a[2] "\"";
            } else if (match($0, "--([^[:space:]=]+)=(.*)", a)) {
                gsub("-", "_", a[1]);
                print "check_var " a[1]  " \"" a[2] "\"";
            } 
        }'`
    #echo $cmd
    eval $cmd
    shift
done

prefix=${prefix:-"/usr/local"}
exec_prefix=${exec_prefix:-$prefix}
bindir=${bindir:-${exec_prefix}/bin}
libexecdir=${libexecdir:-${exec_prefix}/libexec/fbpanel}
datadir=${datadir:-${prefix}/share/fbpanel}
mandir=${mandir:-${prefix}/man}

echo "Install pathes are:"
prn_var prefix
prn_var exec_prefix
prn_var bindir
prn_var libexecdir
prn_var datadir
prn_var mandir

echo "Enabled features"
prn_feature cpu
prn_feature devel

